# FGen - file generator (converter)
FGen is used in Dios CMS.

FGen can be used in any PHP project.

# FGen - генератор (конвертер) файлов

FGen используется в Dios CMS для обработки загружаемых и сохраненных файлов.

FGen может использоваться в любом PHP проекте. Пакет использует PSR-4.

FGen - PHP-библиотека (пакет) для обработки и конвертации файлов.

Сам пакет не содержит функций обработки файлов, а предоставляет набор инструментов и интерфейсов для удобной работы с пакетом:

- содержит простые и понятные интерфейсы для работы с пакетом: вызов генерации файла, расширение пакета, разработка и тестирование собственных библиотек и т.д.;
- легко расширяется добавлением новых драйверов и обработчиков (это действительно просто), а также просто заменяются компоненты пакета и его происходных;
- легко управляется и контролируется;
- легок в изучении;
- работаем со всеми типами файлов (определяется разработчиками драйверов и обработчиков);
- возвращает необходимое количество данных для дальнейшей работы с файлами.

Работая с данным пакетом исчезает необходимость постоянного переписывания или дописывания функций в существующие классы. Кроме того, если будет использован хорошо спроектированный и разработанный обработчик, то неообходимость в написании своих обработчиков отпадет.

## Примеры использования

## Определения

Для понимания пакета требуется знать значение некоторых определений используемых в описании его работы.

Чтобы работать с пакетом, необходимо настроить класс FGen и передать в него файл на обработку.

Настройка класса заключается в задании драйверов, правил генерации файлов, скриптов.

Правила или правила генерации файлов - набор данных (массив) содержащий список драйверов, список обработчиков определенных драйверов и возможные варианты обработки файлов с настройками для обработки.

Драйвер - имя группы объединяющая обработку файлов с одним типом или со схожими типами содержимого. Обычно название драйвера соотвествует типу файла и его расширению, например, JPEG, PNG, SVG, PDF, MP3, DOCX и т.д.
Определение "Драйвер" унаследовалось из предыдущей версии библиотеки. Там из класса драйвера вызывался обработчик файла. Сейчас "Драйвер" - синоним слова "Группа" и для него не используется отдельный класс. В драйвере выполнялся глубокий анализ типа, но сейчас эту функцию выполняет "Инспектор".

Обработчик - класс выполняющий обработку файла, например, создание модификаций файлов, конвертация файла, изменение существующего файла и т.д. Действия определяемые обработчикам и название операций обработок устанавливаются разработчиком обработчика, при этом, рекомендуется следовать единому именованию операций (режимов обработки) и единому именования кодов обработчиков.

Режим обработчика - произвольное название операции обработки файла несущее смысловую нагрузку, например, resize, thumbnail и т.д. В названиях режимов обработчика лучше использовать устоявшиеся названия, т.к. они могут использоваться в самих обработчиках для определения операции. Иначе, в опциях (параметрах) инициализации обработки файла необходимо указывать метод обработки файла определенный в обработчике.

Параметры обработчика (конфигурация обработчика) - настройки обработки файла определяющие действия обработчика, ожидаемый результат, метод обработки и при необходимости класс-обработчика.

Скрипт - название и список необходимых операций над файлов в виде списка драйверов, обработчиков и вариантов обработки. Отличие скрипта от правил в том, что скрипт содержит только список необходимых названий драйверов, обработчиков и вариантов обработки, и не содержит никакой информации о настройках обработки файлов. Вариантов скриптов может быть много, а правила генерации файлов - одни.

Определитель типа файла (драйвера) - класс определяющий драйвер обработки файла без глубокого анализа файла. Т.е. определение файла может происходить по имени файла и/или по его MIME.
Класс определителя можно подменять, но целью такой обработки должно быть быстрое определение типа файла (особенно это важно при массовой обработки файлов).

Инспектор - объект выполняющий проверку файла на соответствие выбранного типа (драйвера или группы). По сути выполняет ту же функцию, что и определитель типа файла, но может выполнить более глубокий анализ файла.

Связь между драйвером и типами файла - отношение используемое для определения драйвера обработчика файла на основе типа файла. Отношения используются для решения проблем схожих расширений файлов (например, *.jpeg, *.jpe, *.jpg) и разных значений из разных спецификаций MIME-типов (). Они сводят эти значения к одной группе файлов (к одному драйверу) и к одной группе возможных обработчиков.

## Установка пакета

Установка пакета выполняется через composer, но может быть установлен вручную.

composer require belca/fgen

use Belca\FGen\FGen;

...

$config = [
    'relations' => [
        'image/jpeg' => 'jpg',
        'image/png' => 'png',
    ],
    'inspectors' => [
    ],
    'rules' => [
        'jpg' => [
            //'_class' => 'handler class name', // optional
            'original' => [
                //'_class' => 'handler class name', // optional
                'changed' => [
                    '_method' => 'resize', // optional
                    //'_class' => 'handler class name', // optional
                    'width' => 1400,
                    'height' => null,
                    'crop' => false,
                    'compression' => 95,
                ]
            ],
            'resize' => [
                'tiny' => [
                    'width' => 400,
                    'height' => null,
                    'crop' => false,
                    'compression' => 85,
                ],
                'small' => [
                    'width' => 600,
                    'height' => null,
                    'crop' => false,
                    'compression' => 85,
                ],
                'normal' => [
                    'width' => 1200,
                    'height' => null,
                    'crop' => false,
                    'compression' => 90,
                ],
            ],
            'thumbnail' => [
                'tiny' => [
                    'width' => 200,
                    'height' => 150,
                    'crop' => true,
                    'compression' => 75,
                ],
                'small' => [
                    'width' => 400,
                    'height' => 300,
                    'crop' => true,
                    'compression' => 80,
                ],
            ],
        ]
    ],
    'scripts' => [],
    'drivers' => [],
];

$fgen = new FGen(config);

$filenames = [
    '/home/dios/file.jpg',
    '/home/dios/file.png',
    '/home/dios/file.pdf',
    '/home/dios/file.avi',
    '/home/dios/file_fake.jpg',
];

foreach ($filenames as $filename) {
    $fgen->file($filename);
}

// Output:
Обработка первого файла ('/home/dios/file.jpg'):
1. Будет определен тип файла или группа файла (зависит от определителя). По умолчанию MIME-тип image/jpeg.
2. На основе типа файла и переменной отношений $relations определяем драйвер/группу обработки файла. В текущем случае это будет группа 'jpg'.
3. По имени драйвера/группы определяем инспектора файла. Посколькую он не задан, считается, что файл соответствует указанному типу.
4. Выполняем поиск и запуск указанных обработчиков на основе определенного драйвера/группы. Приоритет запуска обработчика идет от конкретных настроек обработки до имени драйвера (менее важный), как локальные и глобальные переменные. Т.о. может быть объявлен общий обработчик для одного дравера, обработчик для операций обработки (сжатие, конвертация, миниатюра и т.п.), и обработчик для конкретных модификаций (сжатие оригинала изображения, создание маленькой миниатюры, создание средней миниатюры и т.п.).
Порядок запуска обработчиков соответствует заданному сценарию.
У операции обработки оригинального файла задана одна модификация - изменение оригинального файла на основе метода Resize. Метод Resize объявлен в общем классе-обработчике и будет вызван в том классе.
5.


## Расширение пакета и разработка пакетов

### Новый драйвер

### Новый обработчик


$configuration = [
  'rules' => [],
  'scripts' => [],
  'drivers' => [],
];

FGen($configuration = null); // задаются настройки обработки файла: правила и сценарии

FGen->setConfig($configuration);
FGen->addConfig($configuration, $replace = true);
FGen->getConfig();

FGen->setRules($rules); // правила обработки файлов: настройки, варианты и их значения
FGen->getRules($rule = null);
FGen->getRule($rule);
FGen->addRules($rules, $replace = true);

FGen->setScripts($scripts); // скрипты обработки данных
FGen->getScripts($script = null);
FGen->getScript($script);
FGen->addScripts($scripts, $replace = true);
FGen->addScript($name, $script, $replace = true);

FGen->setDrivers($drivers); // обработчики файлов или групп файлов (jpg, png, gif, svg, doc, docs)
FGen->getDrivers($driver = null);
FGen->getDriver($driver);

FGen->addDriver($driver, $replace = true);

FGen->file($filename, $options) // задаются конкретные настройки обработки
